#include "sys.h"
#include "delay.h"
#include "usart.h"
#include "FreeRTOS.h"
#include "task.h"
#include "usart_referee.h"
#include "bsp_can1.h"
#include "bsp_time_8.h"
#include "decision.h"
#include<stdlib.h>

u16 time[1000] = {341,567,334,900,569,624,578,958,662,964,405,445,481,327,461,791,495,342,927,836,491,904,702,453,592,782,921,816,418,595,847,326,371,638,769,612,767,699,535,394,303,311,822,533,473,764,741,311,553,868,647,644,762,857,737,559,623,941,529,378,716,535,790,742,588,306,940,842,664,548,446,305,790,729,870,950,606,601,893,348,329,323,584,654,856,940,366,676,931,708,444,539,426,423,937,838,318,982,829,741,933,615,739,558,604,430,977,506,473,986,421,345,624,472,970,529,477,473,497,712,486,990,361,736,955,567,855,474,831,452,350,750,441,324,966,930,607,391,807,437,357,687,753,883,545,809,309,958,721,688,422,746,506,730,613,768,500,691,862,555,910,359,624,537,848,483,595,841,402,850,791,336,574,820,696,521,348,399,368,984,881,834,353,899,818,938,900,588,927,767,528,493,448,383,607,621,610,617,713,714,609,916,335,951,600,649,719,356,698,503,924,808,544,709,589,802,695,485,593,643,723,487,914,703,748,300,458,618,580,496,398,881,989,798,309,857,472,822,638,692,738,679,990,557,558,891,515,788,556,611,402,834,772,755,328,546,762,986,975,733,769,842,344,316,481,798,822,751,521,399,357,776,892,889,475,512,800,710,303,569,661,988,401,989,855,623,402,385,682,785,788,926,917,957,332,432,969,354,821,689,676,829,568,992,725,355,934,749,741,712,345,860,318,553,339,823,479,396,887,929,449,937,566,649,493,395,797,416,586,305,988,482,855,834,914,801,816,671,486,663,413,855,685,753,512,608,732,945,413,756,621,958,846,982,781,944,396,922,429,361,935,450,973,966,444,959,692,839,753,724,554,410,845,649,886,913,574,322,368,318,887,405,758,691,702,425,877,514,514,924,934,974,872,859,933,370,787,597,818,777,573,370,663,868,692,985,602,380,813,927,902,899,727,825,443,824,823,872,761,481,503,432,305,593,625,731,392,442,722,786,764,500,587,960,313,474,570,770,535,333,411,860,996,767,585,950,440,694,895,924,319,325,976,994,558,702,871,366,778,493,351,584,618,764,419,352,300,887,560,826,910,857,970,315,776,427,443,658,464,509,482,586,465,987,477,774,825,727,329,728,523,820,902,562,423,396,537,961,695,625,864,860,902,716,430,326,611,971,411,647,453,820,690,524,388,363,340,851,762,829,400,513,358,378,965,707,577,800,458,439,503,460,757,524,477,508,413,487,501,750,760,328,693,384,805,540,611,304,535,456,772,950,923,785,556,416,526,557,426,357,937,471,369,961,596,722,517,612,417,796,685,541,923,629,729,665,559,832,896,755,453,462,384,634,654,472,757,669,432,463,807,683,511,735,567,748,775,638,423,742,954,511,641,875,759,625,721,670,526,734,805,583,350,898,879,601,593,434,537,934,956,893,676,805,962,348,781,600,713,841,555,655,842,562,611,377,424,778,652,543,596,373,540,513,475,772,518,910,617,532,412,895,869,331,740,888,985,490,897,789,390,745,753,714,751,440,644,358,635,659,992,905,364,581,803,629,975,608,892,697,349,456,661,427,467,441,529,740,813,774,601,777,915,583,813,492,924,301,592,659,870,828,327,884,575,886,398,770,987,347,704,803,521,563,406,563,910,771,489,340,564,642,919,913,891,704,618,432,350,305,375,439,603,522,398,347,584,648,471,664,813,875,845,312,346,778,669,862,419,985,589,844,365,640,445,608,618,870,801,623,432,972,852,887,870,663,801,603,723,327,700,669,315,965,328,843,447,988,443,337,309,863,449,781,488,442,908,860,521,658,854,888,446,990,549,543,730,720,348,767,636,783,835,326,785,338,353,729,324,648,623,859,357,566,344,555,518,826,511,325,355,501,449,696,684,715,764,542,675,713,342,696,548,872,426,906,573,929,504,705,626,712,775,993,765,936,336,741,314,694,856,652,436,338,482,955,315,731,330,641,925,911,737,986,390,550,362,934,693,853,716,452,308,562,833,854,503,834,703,556,448,924,717,313,809,528,800,380,618,358,550,655,861,864,303,476,543,609,502,361,789,748,882,653,874,420,802,923,631,769,678,959,408,519,471,903,545,981,904,792,785,413,698,989,422,638,437,410,961,934,908,461,759,493,415,369,737,469,358,300,971,664,717,415,355,415,430,539,412,888,382,854,985,710,984,574,980,715,351,541,915,579,610,998,973,388,477,932,856,989,513,508,641,690,623,663,328,984,578,500,471,785,574,671,433,767,553,595,968,825,876,529,950,798,809,793,786,980,616,649,};
	
int ccc = 0;
int delay = 0;
int last_armor_id = 0,last_shoot_heats = 0,shoot_heats = 0;
int armor_id = 0;
int robot_id = 0;
int rand_time = 0;

extern decision_all_data_t decision_all_data;


int main(void)
{ 
	NVIC_PriorityGroupConfig(NVIC_PriorityGroup_4);//设置系统中断优先级分组4
	delay_init(168);		//初始化延时函数
	usart6_init();
	ENC_Init();
	CAN_Configure();
	delay_ms(500);
	
	while(1)
	{			
		  last_armor_id = armor_id;
		  last_shoot_heats = shoot_heats;
			if(decision_all_data._robot_hurt.robot_hurt.armor_type != 10 && decision_all_data._robot_hurt.robot_hurt.hurt_type != 10 && decision_all_data._robot_hurt.robot_hurt.hurt_type == 0)
			{	
				armor_id = decision_all_data._robot_hurt.robot_hurt.armor_type + 1;
				decision_all_data._robot_hurt.robot_hurt.armor_type = 10;
				decision_all_data._robot_hurt.robot_hurt.hurt_type = 10;
				delay = 0;
				rand_time = (rand_time+1)%1000;
			}else{
				armor_id = 0;
			}
			if(armor_id == 0)
			{
				delay ++;
				if(delay<(time[rand_time]+450))
				{
					armor_id = last_armor_id;
				}
			}
			
			if(decision_all_data._power_heat_data.power_heat_data.shooter_id1_17mm_cooling_heat <= 800 )
				shoot_heats = decision_all_data._power_heat_data.power_heat_data.shooter_id1_17mm_cooling_heat;
		
    robot_id = 	decision_all_data._game_robot_state.game_robot_state.robot_id;
		can1_send_encoder( TIM8->CNT, armor_id, shoot_heats,robot_id );
	  ccc ++;
		delay_ms(1);
	}
	
}






